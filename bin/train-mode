#!/bin/bash
#
# Switches train-mode on or off, respectively killing or restarting energy
# consuming stuff to enable longer battery usage.

set -euo pipefail


usage() {
    echo "Usage: $(basename $0) [on|off]" >&2
    echo "Usage: $(basename $0) [-h|-help]" >&2
}

ensure_running() {
    process="$1"
    if [[ -z "$(pidof "$process")" ]]; then
        "$process" 2>/dev/null &
    fi
}


# Parse options
while getopts "h" opt; do
  case $opt in
    h|help)
        usage
        exit 0
        ;;
    ?)
        usage
        exit 1
        ;;
  esac
done
shift $(($OPTIND-1))


# Parse state
state='on'
if [[ $# -gt 0 ]]; then
    state="$1"
    if [[ x"$state" != x'on' && x"$state" != x'off' ]]; then
        usage
        exit 1
    fi
fi


# Set some variables according to state to keep duplication to a minimum
if [[ x"$state" = x"on" ]]; then
    action_name='Stopping'
    systemd_action='stop'
    brightness='25'
else
    action_name='Starting'
    systemd_action='start'
    brightness='90'
fi


echo 'User systemd'
echo "  $action_name Dropbox"
systemctl --user "$systemd_action" dropbox || true
echo "  $action_name Deluge"
systemctl --user "$systemd_action" deluged || true
echo


echo "$action_name browsers, mail clients and IMs"
if [[ x"$state" = x"on" ]]; then
    killall -q skype firefox opera chromium thunderbird dropbox || true
    killall -q opera || true  # Really makes sure it gets killed
else
    for program in firefox-aurora skype; do
        ensure_running "$program" &
    done
fi
echo


echo "Setting screen brightness to $brightness"
$HOME/.config/herbstluftwm/dzen/dbrightness.sh -set "$brightness" &
